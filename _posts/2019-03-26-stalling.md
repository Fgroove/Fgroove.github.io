---
layout: post
title:  "Stalling"
date:   2019-03-25 8:55:01 +0800
categories: 基于动态的恶意软件分析
tag: 反沙箱对抗技术
---
* content
{:toc}


# The Power of Procrastination: Detection and Mitigation of Execution-Stalling Malicious Code
---
## ABSTRACT
恶意软件仍然是当今互联网上最重要的安全问题之一。每当反恶意软件解决方案变得流行时，恶意软件作者通常会立即做出反应并修改其程序以逃避防御机制。例如，最近，恶意软件作者越来越多地开始创建可以逃避动态分析的恶意代码。

最近逃避动态分析系统的一种形式是停止代码。通常在任何恶意行为之前执行失速代码。攻击者的目标是延迟恶意活动的执行时间足够长，以便自动动态分析系统无法提取有趣的恶意行为。本文介绍了第一种检测和缓解恶意拖延代码的方法，并确保在分析样本分配的时间内取得进展。实验结果表明，我们的系统HASTEN在实践中运行良好，并且能够检测真实恶意软件样本中的其他恶意行为。

## 1. INTRODUCTION
恶意软件（恶意软件）是Web上许多安全问题背后的驱动力。例如，世界上大部分的垃圾邮件是由僵尸网络发送的[16]，特洛伊木马程序窃取了网上银行网站的帐户凭据[27]，恶意软件程序参与了点击欺诈活动和分布式拒绝服务攻击[15] ]。

恶意软件研究是一场军备竞赛。随着新的反恶意软件解决方案的引入，攻击者正在更新其恶意代码以逃避分析和检测。例如，当基于签名的反病毒扫描程序被广泛采用时，攻击者开始使用代码混淆和加密来阻止检测。因此，研究人员和安全供应商转向专注于恶意软件的运行时（动态）行为的技术。

基于行为的恶意软件检测的一个重要推动因素是动态分析系统（如ANUBIS [2]，CW-SANDBOX [3]，NORMAN SANDBOX [4]和TEMU [25]）。这些系统在受控环境中执行捕获的恶意软件程序并记录其操作（例如系统调用，API调用和网络流量）。根据收集的信息，可以决定程序的恶意性质，优先考虑手动分析工作[8]，并自动导出捕获恶意软件行为的模型[14,19]。然后可以部署这些模型以保护最终用户的机器。

随着动态分析系统变得越来越流行，恶意作者通过设计技术来确保他们的程序在这样的自动分析环境中执行时不会泄露任何恶意活动。显然，当恶意软件在分析期间没有显示任何不需要的活动时，不能提取检测模型。对于反恶意软件研究人员来说，这些逃避尝试在实践中构成了一个重大问题。

阻止动态分析的常用方法是识别执行样本的环境。为此，恶意软件程序使用检查（所谓的红色药丸）来确定它是在虚拟机[13,24]中执行还是在诸如Qemu [20,22,23]之类的系统仿真器中执行。每当恶意软件程序能够检测到它在这样的环境中运行时，它就可以简单地退出。

研究人员对回避检查（红丸）作出反应，提出了更加透明的分析环境[11,12]。另一种方法侧重于检测虚拟平台中程序执行与真实硬件之间的差异[6,17]。如果发现这种差异，可以删除负责差异的检查。最后，执行多路径探索[9,21]或识别“恶意触发器”[10]的系统可以检测并绕过防范恶意活动的检查。

在军备竞赛的下一步中，恶意软件作者已经开始在其恶意程序中引入拖延代码。此停顿代码在任何恶意行为之前执行 - 无论执行环境如何。这种规避代码的目的是延迟恶意活动的执行时间足够长，以便自动分析系统放弃样本，错误地假设程序不起作用，或者不执行任何感兴趣的操作。重要的是要注意停止代码的问题会影响所有分析系统，甚至是那些完全透明的分析系统。此外，停止代码不必执行任何检查。

因此，旨在检测恶意软件触发器或探索多个执行路径的系统不会揭示任何其他行为。

随着代码停滞，攻击者利用自动恶意软件分析系统的两个常见属性：首先，系统执行单个样本所花费的时间是有限的。通常，自动恶意软件分析系统将在几分钟后终止样本分析。这是因为系统必须在可以从单个样本获得的信息与每天可以分析的样本总数之间进行权衡。其次，恶意软件作者可以制作他们的代码，以便在分析环境中执行所需的时间比在实际受害者主机上执行的时间长得多。因此，即使样本可能在分析环境中长时间（许多分钟）停止并且不执行任何恶意活动，受害主机上感知的延迟也只有几秒钟。这很重要，因为恶意软件作者认为受害者机器上的延误是有风险的。原因是反病毒软件，专注用户或系统重启更有可能检测到或终止恶意进程。

我们在HASTEN中实施了我们的方法，这是我们动态分析系统ANU-BIS的扩展。 我们的实验评估表明，HASTEN在实践中是有效的，可以揭示真实恶意软件中的其他行为。

本文做出以下贡献：

* 我们提出了第一种方法来检测和处理真实恶意软件中的恶意停滞代码，并确保在分配用于分析恶意软件样本的时间内取得进展。
* 我们提出HASTEN，一种动态分析系统扩展，用于检测和被动地减轻停滞代码的影响。 为此，我们确定停滞代码区域并使用减少的日志记录执行它们。
* 我们向HASTEN引入了一个有效的扩展，它强制执行恶意软件，以采取跳过先前识别的停滞代码的路径。 这有助于减少日志记录不足的情况。

