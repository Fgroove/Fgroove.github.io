---
layout: post
title:  DigFuzz
date:   2019-03-27 8:55:01 +0800
categories: 基于动态的恶意软件分析
tag: 反沙箱对抗技术
---
* content
{:toc}


# Probabilistic Path Prioritization for Hybrid Fuzzing
## Abstract
---

混合模糊测试结合了模糊测试和协同执行，已成为软件漏洞检测的先进技术。基于对模糊和经验性执行本质上是互补的观察，最先进的混合模糊测试系统部署了“需求启动”和“最佳切换”策略。虽然这些想法听起来很有意思，但由于过于简单的假设，我们指出了它们中的几个基本限制。然后，我们提出了一种新颖的“歧视性调度”策略，以更好地利用有形执行的能力。我们设计了一种新的基于蒙特卡罗的概率路径优先级模型，用于量化每条路径的难度，并优先考虑它们的执行。该模型将模糊测试视为随机抽样过程。它根据采样信息计算每个路径的概率。最后，我们的模型优先考虑并指定最困难的路径来执行。我们实现了原型系统DigFuzz，并使用两个有代表性的数据集评估我们的系统。结果表明，在各个主要方面，DigFuzz中的复杂执行性能优于最先进的混合模糊测试系统。特别是，DigFuzz中的执行执行有助于发现更多的漏洞（12对5），并在CQE数据集上产生比在Driller中执行的更多代码覆盖（18.9％对3.8％）。



## 1. Introduction

软件漏洞被认为是对网络空间最严重的威胁之一。因此，发现一个软件中的漏洞至关重要[12]，[16]，[25]，[27]，[32]。最近，混合模糊测试，模糊测试和执行模式的组合，在漏洞发现中变得越来越流行[5]，[29]，[31]，[39]，[42]，[46]。由于模糊测试和模仿执行本质上是互补的，因此将它们结合起来可以潜在地利用它们的独特优势并减轻弱点。更具体地说，模糊测试是精通探索包含一般分支（具有大的满足值空间的分支）的路径，但是不能探索包含特定分支的路径（具有非常窄的满足值空间的分支）[27]。相反，concolic执行能够生成具体的输入，确保程序沿着特定的执行路径执行，但它会遇到路径爆炸问题[9]。在混合方案中，模糊测试通常承担由于高吞吐量而导致的路径探索的大多数任务，并且模板执行有助于在探索具有低概率的路径中进行模糊测试并且生成满足特定分支的输入。通过这种方式，可以减轻分支执行中的路径爆炸问题，因为分析执行仅负责探索可能阻止模糊测试的低概率路径。

关键的研究问题是如何结合模糊测试和执行模式以实现最佳的整体性能。 Driller [39]和混合动力测试[29]采取“需求启动”策略：模糊测试首先开始，并且只有当模糊测试在一段时间内无法取得任何进展时才会启动模仿执行，等等。最近的一项工作[42]提出了一种“最佳转换”策略：它分别通过模糊和共同执行来量化探索每条路径的成本，并选择更经济的方法来探索这条路径。

我们使用DARPA CQE数据集[13]和LAVA-m数据集[15]评估了“需求启动”和“最佳转换”策略，并发现尽管这些策略听起来很有趣，但由于不符合以下原因，它们都没有充分发挥作用。有元或过度简化的假设。

对于“需求启动”策略，首先，模糊器的卡住状态不是启动执行执行的良好指标。模糊测试正在取得进展并不一定意味着不需要进行执行。模糊器仍然可以探索新代码，即使它已经被许多特定分支阻塞，而因为模糊器未处于卡住状态，因此强制执行器被迫空闲。其次，该策略无法识别阻止模糊测试的特定路径。一旦模糊器卡住，需求启动策略就会将模糊器保留的所有种子提供给用于探索所有错过路径的执行。然后，这种大量错过的路径会让执事执行不堪重负，并且可能会在很长一段时间后为特定路径生成帮助输入。到那时，模糊器可能已经生成了一个良好的输入来遍历该特定路径，从而使整个执行执行变得毫无用处。

同样，尽管“最佳切换”策略旨在基于可靠的数学模型（即，具有成本的马尔可夫决策过程，简称MDPC）做出最优决策，但是量化每条路径的模糊测试和共存执行的成本是非常重要的。例如，为了量化特定路径的独立执行成本，MDPC需要收集已经很昂贵的路径约束。结果，MDPC的总吞吐量大大降低。此外，在量化模糊测试的成本时，MDPC假设所有测试用例均匀分布。这种假设过于简单，因为许多最先进的模糊测试技术[4]，[12]，[16]是自适应和进化的。最后，即使可以准确地估计模糊测试和执行执行的成本，但要将它们标准化以进行统一比较是具有挑战性的，因为这两种成本是通过具有不同度量的技术来估计的。

基于这些观察，我们在构建混合模糊测试系统时争论以下设计原则：1）由于模板执行比模糊测试慢几个数量级，我们应该只让它解决“最难的问题”，并让模糊测试采取路径探索的多数任务; 2）由于高通量对于模糊测试至关重要，因此任何额外的分析都必须是轻量级的，以避免对模糊测试的性能产生不利影响。

在本文中，我们提出了一种“判别性调度”策略，以更好地结合模糊和执行。也就是说，我们优先考虑路径，以便花哨的执行仅适用于最难以突破的选择性路径。因此，可以更好地利用有形执行的能力。然后，这种“歧视性调度”策略的关键是量化每条路径的难度级别的轻量级方法。先前的工作通过执行昂贵的符号执行来解决这个问题[18]，因此不适合我们的目的。

特别地，我们提出了一种新的基于蒙特卡罗的概率路径优先级（M C P 3）模型，以有效的方式量化每个路径的难度。更具体地说，我们通过随机输入可能遍历此路径的概率来量化路径的难度。为了计算这个概率，我们使用蒙特卡罗方法[35]。核心思想是将模糊测试视为随机抽样过程，将随机执行视为整个程序空间的样本，然后根据抽样信息计算每个路径的概率。

我们已经实现了一个名为DigFuzz的原型系统。它利用流行的模糊器，美国模糊Lop（AFL）[47]作为模糊组件，并在开源符号执行引擎Angr之上构建了一个复杂的执行器[38]。我们使用来自DARPA Cyber Grand Challenge [13]和LAVA数据集[15]的CQE评估来评估DigFuzz的有效性。评估结果表明，与最先进的混合系统相比，DigFuzz中的复杂执行对代码覆盖率的增加和发现的漏洞数量的增加做出了更大的贡献。更具体地说，DigFuzz中的执行执行有助于发现更多的漏洞（12对5），并在CQE数据集上产生更多的代码覆盖率（18.9％对3.8％），而不是在Driller [39]中执行。

贡献。该文件的贡献概述如下：

* 我们对两种最先进的混合模糊测试策略（“需求启动”和“最佳切换”）进行独立评估，并发现以前未报告过的几个重要限制。
* 我们提出了一种新颖的“判别式调度”策略，作为构建混合模糊测试系统的更好方法。它遵循两个设计原则：1）让模糊测试进行路径探索的大多数任务，并且只分配最困难的路径进行有条理的执行; 2）路径困难的量化必须是轻量级的。为了实现这两个原则，我们设计了一个基于蒙特卡罗的概率路径优先模型。
* 我们实施原型系统DigFuzz，并使用DARPA CQE数据集和LAVA数据集评估其有效性。我们的实验表明DigFuzz在更多发现的漏洞和更高的代码覆盖率方面优于最先进的混合系统Driller和MDPC。

## Background And Motivation

Fuzzing [30]和concoic execution [9]是软件测试和漏洞检测的两种代表性技术。 由于观察到模糊和执行的执行在本质上可以相互补充，已经提出了一系列技术[5]，[29]，[31]，[39]，[42]将它们组合在一起并创建混合模糊系统。 通常，这些混合模糊测试系统分为两类：“需求启动”和“最佳切换”。

### A. Demand Launch

最先进的混合方案，如Driller [39]和混合动力系统测试[29]部署了“需求启动”战略。在Driller [39]中，由于模糊器在一段时间内无法取得任何进展，因此该模板执行器仍处于空闲状态。然后，它依次处理来自模糊器的所有保留输入，以生成可能有助于模糊器的输入，并进一步导致新的代码覆盖。类似地，混合分析测试[29]通过混合测试获得了对程序状态空间的深入和广泛的探索。它通过利用随机测试的能力快速到达程序状态，然后通过执行执行彻底探索邻居状态。

在一个问题上，必须有两个假设才能使“需求启动”战略按预期发挥作用：
（1）非卡住状态的模糊器意味着不需要执行。只有当模糊器卡住时，混合系统才应该开始执行。
（2）卡住状态表明模糊器在可接受的时间内无法在发现新的代码覆盖范围方面取得任何进展。此外，具有执行力的执行能够找到并解决阻塞模糊器的难以解决的条件检查，以便模糊测试可以继续发现新的覆盖范围。

观察。为了评估“需求启动”战略的表现，我们仔细研究了Driller如何在DARPA Cyber Grand Challenge（CGC）的12个小时中工作12小时，并找到五个有趣且令人惊讶的事实。
（1）Driller仅在118个二进制文件中的49个中调用了concoic执行，这意味着模糊器只会卡在这49个二进制文件上。这一事实与Driller [40]的论文中报道的数字（42）相当。
（2）对于事实1中的49个二进制文件，我们统计计算卡住时间段，卡住时间段的分布如图1所示。我们可以观察到超过85％的卡住时间段低于100秒。
（3）平均而言，为一个具体的输入完成动态符号执行需要1654秒。
（4）在测试的12小时内，由模糊执行器处理的只有7.1％（23915中的1709个）由模糊器保留的输入。图2显示了由于执行的输入数量和模糊测试保留的输入数量之间的巨大差距。
（5）Driller中的模糊器确实可以从事实1的49个二进制文件中的13个二进制文件中获得有关执行（从至少一个由concolic执行产生的输入）的帮助，在1709次执行的系统执行后总共输入51个输入。

限制。上述结果表明“需求启动”战略的两个主要局限。

首先，模糊器的卡住状态不是判断是否需要执行模板的好指标。根据事实1，模糊器仅停留在49个二进制文件上，这意味着其他77个二进制文件永远不会启动模仿执行。对这77个二进制文件的源代码进行手动调查表明，它们都包含可以阻止模糊测试的特定分支。进一步结合事实2，我们可以看到处于卡住状态的模糊器并不一定意味着它实际上需要执行，因为大多数卡住状态非常短（85％的卡住状态不到100秒）。这些事实打破了上述假设1。

其次，“需求启动”策略无法识别阻止模糊测试的特定路径，从而导致非常低效的执行。一方面，平均执行平均需要1654秒来处理一个输入（事实3）。另一方面，模糊器通常比常规执行可以保留更多的输入（事实4）。结果，对应于阻止模糊测试的特定分支的输入（即，可能导致执行到目标位置的输入）仅具有非常小的机会被通过结构执行来拾取和处理。因此，上述假设2在实践中并不真正成立。事实5可以进一步证实这一结论，尽管它是在49个二进制文件上发布的，但是对于仅仅13个二进制文件的执行可以帮助模糊测试。此外，在1709次执行经验之后，模糊执行器仅导入了51个来自执行执行的输入，表明由于执行而产生的输入质量非常低。

### B. Optimal Switch

“最佳切换”策略旨在基于数学模型（即，具有成本的马尔可夫决策过程，简称MDPC）对使用哪种方法来探索给定的执行路径做出最佳决策。 为了获得最佳性能，MDPC始终选择成本较低的方法来探索每条路径。 为了使这一战略运作良好，必须遵循以下假设：

（1）可以准确地估计通过模糊和经验执行来探索路径的成本。
（2）成本估算的开销可以忽略不计。
（3）用于做出最优决策的算法是轻量级的。

观察。 为了评估“最佳切换”的性能，我们评估了MDPC如何在CQE数据集中对118个二进制文件工作12小时，并有3个有趣的观察结果。



（1）表I显示了模糊测试，独立执行和MDPC中的最佳决策之间的吞吐量差距。我们可以观察到最优决策非常昂贵，比模糊测试大几千倍。
（2）由于MDPC在探索每条路径之前做出最佳决策，因此整体分析吞吐量显着降低，从纯模糊测试中每秒执行417次到MDPC中每秒执行2.6次。
（3）由于吞吐量降低的影响，MDPC仅在29个二进制文件中发现漏洞，而纯模糊测试可以发现67个二进制文件中的漏洞。
由于MDPC在探索之前做出了最佳决策
每条路径，昂贵的最优决策都会带走模糊测量的高吞吐量。作为优化，我们可以将最佳决策移出，使其与模糊测试并行工作，并构建并发MDPC。也就是说，并发MDPC中的最优决策不会干扰模糊测试的工作进度，它只是从模糊测试中收集覆盖率统计数据来计算成本。从这个并发的MDPC的评估，我们有另一个观察。
（4）几乎所有错过的路径都决定在模糊测试开始后的几秒钟内通过执行的方式进行探索。通过检查覆盖率统计，我们观察到模糊器能够在几秒钟内生成数百个测试用例，这导致基于MDPC中的算法通过模糊测试来探索错过路径的高成本。相反，即使我们将最高的求解成本（定义为[42]的50）分配给每个路径约束，也可以降低执行成本。

限制。上述观察结果表明，“最佳转换”策略的关键限制是估计通过模糊测试和经常性执行来探索路径的成本是重量级且不准确的，这掩盖了制定最优解决方案的好处。

首先，估计分配执行的成本依赖于收集路径约束并确定这些约束的解决成本。由于收集路径约束需要将程序语句转换为符号表达式，因此这种解释也是重量级的，特别是对于具有长路径的程序。此外，MDPC设计了一种贪婪算法以实现最佳决策。该算法依赖于路径敏感的程序分析。对于具有大状态的程序，路径敏感分析也是重量级的。

其次，准确估计通过模糊测试和经常性执行探索给定路径的成本是非常重要的。 MDPC根据平等的复杂性估算解决成本，并根据覆盖统计估计随机测试的成本。这些估计涉及模糊测试的运行时吞吐量，约束求解器的性能以及符号执行引擎，并且它们中的每一个本质上是不同的程序分析技术。因此，定义统一度量以评估不同技术的成本具有挑战性。