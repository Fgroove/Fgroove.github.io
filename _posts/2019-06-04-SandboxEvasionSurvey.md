---
layout: post
title:   "SandboxEvasionSurvey"
date:   2019-06-04 13:55:01 +0800
categories: "research proposal"
tag: "技术思路"

---
* content
{:toc}






# VMRay沙箱逃逸

## Part 1

这篇文章是当前恶意软件使用的沙箱逃逸技术系列的第一部分。在入门之后，将在后续文章中深入探讨三种主要类别逃逸技术的详细信息。

使用恶意软件分析沙箱作为抵御APT的银弹，十多年前就开始流行起来。当时，恶意软件作者已经找到了基于静态分析（例如传统的防病毒软件产品）使用多态，变质，加密，混淆和反向保护等技术来规避工具的方法。因此，恶意软件分析沙箱现在被认为是抵御高级威胁的最后一道防线。

沙箱的操作原理很简单 — 根据在受控环境中观察到的行为来确定文件是否是恶意的。沙箱允许恶意软件执行其所有恶意操作并记录生成的行为。一段时间后，停止分析并检查结果并扫描典型的恶意行为模式。由于检测不是基于签名，因此沙箱甚至可以检测零日和目标恶意软件（安全研究人员以前从未见过或在防病毒实验室中进行过分析）。

显然，**基于行为的恶意软件检测只有在观察到的文件在分析过程中实际执行恶意操作时才有效**。如果 - 无论出于何种原因 - 在分析过程中没有执行任何有害操作，沙箱会得出结论认为正在检查的文件是良性的。恶意软件作者总是通过**隐藏恶意软件的真实行为**来寻找新的创新方法来逃避沙箱检测。我们将这些方法分为三类：

* 沙箱检测：检测沙箱的存在（并且仅在检测时显示良性行为模式）
* 沙箱漏洞：利用沙箱技术或生态系统中的弱点或差距
* 条件触发：使用基于时间/事件/环境的触发器（在沙箱分析期间未激活）

### 沙箱检测

第一种方法是通过查找沙箱环境和真实受害者系统之间的微小差异来检测沙箱的存在。 

如果检测到沙箱，恶意软件通常会以两种不同的方式作出反应：

* 它立即终止（这本身就是可疑的），
* 或者它显示非恶意行为并且只执行良性操作。 

这里分析了一个[例子](https://www.vmray.com/analyses/663306/report/vti_by_category.html)，其中样本：

* 尝试检测它是否在虚拟机（VM）内运行
* 查看是否有应用程序沙箱运行（在此Sandboxie中）

可以在VMRay威胁标识符（VTI）详细信息中看到这一点，该详细信息显示VMRay识别出沙盒检测尝试并将此行为评为高度恶意。

### 沙箱漏洞

第二种方法直接攻击并利用底层沙箱技术或周围生态系统中的弱点。

 例如，我们最近看到大量恶意软件在内部使用Microsoft COM，因为大多数沙箱无法正确分析此类示例。 其他恶意软件将使用沙盒无法处理的模糊文件格式，或者它们利用沙箱无法处理超过特定大小的文件。 

我们在这里发布了一个[示例](http://www.vmray.com/analyses/663310/report/vti_by_category.html)，其中恶意软件试图“使监视器变得模糊” — 也就是说，通过执行非法的API使用来逃避分析。 这可以是一种有效的方法来隐藏依赖于注入目标机器的钩子或驱动程序的分析器。 但是，由于VMRay不使用挂钩，因此检测到逃逸尝试并对其进行评分。

### 条件触发

第三类代表不会尝试检测或攻击沙箱的恶意软件。 相反，它利用了这种自动化系统的自然缺点。 由于大多数环境中出现大量独特的恶意软件，沙箱分析系统通常只在每个文件上花费几分钟。 因此，通过将恶意有效载荷的执行延迟一定时间，恶意软件可以保持不被发现。 除了时间触发器，恶意软件还可以使用通常不会出现在沙箱中的其他事件，例如： 系统重启或用户交互。 或者，恶意软件可能正在寻找预期目标机器上存在的特定工件，本地化设置等，例如我们[在此](https://www.vmray.com/cyber-security-blog/analyzing-environment-sensitive-malware/)讨论的应用程序。

在这个[例子](http://www.vmray.com/analyses/663313/report/vti_by_category.html)中，我们看到一个分析，其中除了试图检测VM环境之外，恶意软件还参与了“持久性”，安装启动脚本和应用程序以便在重启时生存。

## Part 2

之前的文章介绍了沙箱逃逸技术分为三类：

- 沙箱检测：检测沙箱的存在（并且仅在检测时显示良性行为模式）
- 沙箱漏洞：利用沙箱技术或生态系统中的弱点或差距
- 条件触发：使用基于时间/事件/环境的触发器（在沙箱分析期间未激活）



在这篇文章中，我们将深入探讨第一类沙盒逃避技术的更多细节：当恶意软件专门检测到沙箱的存在并切换到良性行为时。

第一种方法是通过查找沙箱环境和真实受害者系统之间的微小差异来检测沙箱的存在。 如果检测到沙箱，恶意软件通常会以两种不同的方式作出反应：它立即终止（这本身就是可疑的），或者它显示非恶意行为并且只执行良性操作。

### 检测沙箱的存在

有很多技术可以识别沙箱的存在。一旦沙箱被检测出，恶意软件会有不同的反应。

最简单的就是立即终止，这会引起一个红色警告，因为这不是正常良性程序的行为。

另一个操作是显示虚假错误消息。 例如，恶意软件可能会显示某个系统模块丢失或可执行文件已损坏的消息。 

更复杂的恶意软件可能会执行一些良性操作来隐藏真实意图。 

通过深入研究真实恶意软件使用的不同技术，检测它是否在沙箱中执行：

* 检测虚拟化/管理程序

这是最古老的逃避技术之一。 但是，它现在不太重要，因为无论如何许多生产环境（工作站和服务器）都是虚拟化的，而虚拟机（VM）不再仅仅被研究人员和恶意软件分析师使用。

* 最早的方法是检测由于缺乏对虚拟化（半虚拟化）的完全硬件支持而存在的技术工件。 技术包括：
  * 检测流行的VM管理程序的工件，例如， VMWare（“端口0x5658”）或Virtualbox通过后门（“无效操作码”）。
  * 检测通用管理程序工件：最著名的是redpill（“IDTR无法虚拟化”）

这些技术今天不是很有效。 借助硬件虚拟化支持，VM内部的可见工件（如果有）非常少，因为大多数硬件方面现在都由CPU本身进行虚拟化处理。 因此，它们不必由管理程序模拟。

* 目前仍然相关的另一种方法是检测管理程序的实现工件
  * 例如：从MAC地址，设备ID或CPU ID显示供应商，或者从内存中存在某些进程，文件，驱动程序，注册表项或字符串

我们发布了两个分析，演示了几种类型的虚拟化检测。 在第一个中，我们看到尝试检测恶意软件是否在VirtualPC内运行，[这里][http://www.vmray.com/analyses/678148/report/vti_by_score.html].

另一种方法是通过查看注册表值来检测VM的存在。 在此[示例][http://www.vmray.com/analyses/678032/report/vti_by_category.html]中，恶意软件查询注册表项`HKEY_LOCAL_MACHINE\HARDWARE\Description\System`以查找与VMWare等常见VM实施相关的值.

---

* 检测沙箱工件

在这种方法中，恶意软件试图检测的不是虚拟机管理程序，而是沙箱本身。这可以通过以下方式完成

* 使用与以下相关的供应商特定信息
  * 常见的VM产品。例如，某些文件，进程，驱动程序，文件系统结构，Windows ID，用户名等的存在。
  * 生态系统。例如，机制：
    * 感染后将分析环境恢复到干净状态：Deepfreeze，Reborn Cards
    * 与沙箱控制器进行通信：附加侦听端口，特定网络环境（主服务器，......）
* 使用某些沙盒技术进行检测：
  * 大多数沙箱使用钩子，即它们在分析系统内注入或修改代码和数据。 'hook'本质上是一个填充进程，驱动程序和操作系统之间通信的填充层。钩子可以通过多种方式实现，例如：内联钩子，IAT，EAT，代理DLL，过滤器驱动程序等。这使得它们可以通过以下方式检测到：
    * 明确检查某些指令或指针，或通过
    * 验证系统的完整性，例如验证相关系统文件的哈希签名
  * 一些沙箱使用仿真，与本机系统相比，它具有副作用和小的差异，例如不同的指令语义，基于缓存的攻击等。可以通过例如调用未包括在仿真中的模糊CPU指令来检测仿真间隙。当调用失败时，恶意软件将知道它正在模拟环境中运行。